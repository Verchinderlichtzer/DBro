@page "/pesanan"
@layout AdminLayout
@inherits PesananListBase

<PageTitle>Pesanan</PageTitle>

@if (!_loaded)
{
    <MudProgressCircular Indeterminate />
}
else
{
    <MudDataGrid Items="_pesananList" Elevation="2" Dense Bordered QuickFilter="FilterSearch" ShowColumnOptions="false">
        <ToolBarContent>
            <MudStack Row Spacing="2">
                <MudText Typo="Typo.h5">Daftar Pesanan</MudText>
                <MudTooltip Text="Refresh" Arrow Placement="Placement.Bottom">
                    <MudIconButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Dark" Icon="@Icons.Material.Filled.Refresh" OnClick="LoadDataAsync" />
                </MudTooltip>
                <MudTooltip Text="Tambah Pesanan" Arrow Placement="Placement.Bottom">
                    <MudIconButton Variant="Variant.Filled" Size="Size.Small" Icon="@Icons.Material.Filled.Add" Color="Color.Success" OnClick="@(e => NavManager.NavigateTo("/pesanan/form"))" />
                </MudTooltip>
            </MudStack>
            <MudSpacer />
            <MudSwitch @bind-Value="_tampilPelangganLangsung" @bind-Value:after="async () => await LoadDataAsync()" Label="Pelanggan Langsung" />
            <MudSpacer />
            <MudTextField Immediate @bind-Value="_searchTerms" Placeholder="Cari pesanan..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" />
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="@(x => x.Email ?? "(Pelanggan Langsung)")" CellClassFunc="@(x => string.IsNullOrEmpty(x.Email) ? "italic opacity-50" : "")" />
            <PropertyColumn Property="x => x.Tanggal" Format="dd MMMM yyyy" HeaderClass="w-150" />
            <PropertyColumn Property="x => x.Subtotal" Format="N0" HeaderClass="w-0" />
            <PropertyColumn Property="x => x.Potongan" Format="N0" HeaderClass="w-0" />
            <PropertyColumn Property="x => x.Bayar" Format="N0" HeaderClass="w-0" />
            <PropertyColumn Property="x => x.Status.GetDescription()" HeaderClass="w-0" />
            <TemplateColumn HeaderClass="w-0" Title="Opsi">
                <CellTemplate>
                    <MudStack Row Spacing="1" Justify="Justify.Center">
                        @if (!string.IsNullOrEmpty(context.Item.Email) && context.Item.Status == StatusPesanan.MenungguPersetujuan)
                        {
                            <MudIconButton Variant="Variant.Outlined" Size="Size.Small" Icon="@Icons.Material.Filled.Check" Color="Color.Success" OnClick="async e => await ApprovalAsync(context.Item, true)" />
                            <MudIconButton Variant="Variant.Outlined" Size="Size.Small" Icon="@Icons.Material.Filled.Close" Color="Color.Error" OnClick="async e => await ApprovalAsync(context.Item, false)" />
                        }
                        else
                        {
                            <MudIconButton Variant="Variant.Filled" Size="Size.Small" Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" OnClick="@(e => NavManager.NavigateTo($"/pesanan/form/{context.Item.Id}"))" />
                            <MudIconButton Variant="Variant.Filled" Size="Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="e => DeleteAsync(context.Item)" />
                        }
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="Pesanan" RowsPerPageString="Baris / halaman" InfoFormat="{first_item} - {last_item} dari {all_items} data" />
        </PagerContent>
    </MudDataGrid>
}

<MudMessageBox @ref="_deleteConfirmation" Title="Konfirmasi Hapus">
    <MessageContent>
        <MudPaper Elevation="0" MinWidth="300px" Class="mx-5">
            @_deleteMessage
        </MudPaper>
    </MessageContent>
    <NoButton>
        <MudButton Variant="Variant.Filled" Class="ma-1" Color="Color.Error" Size="Size.Small">Ya</MudButton>
    </NoButton>
    <YesButton>
        <MudButton Class="ma-1" Size="Size.Small">Tidak</MudButton>
    </YesButton>
</MudMessageBox>